:: Story JavaScript [script]
/* CourseQuest v1 - SugarCube Story JavaScript */
(function () {
  "use strict";

  var CQ = {};
  CQ.storageKeys = {
    lastGroupName: "cq.lastGroupName"
  };

  CQ.config = {
    stripPunctuation: false,
    collapseWhitespace: true,
    wrongMessage: "æ„Ÿè¬æ‚¨çš„åŠªåŠ›è§£é¡Œï¼â¤ï¸ å†è©¦ä¸€è©¦ï¼ğŸ’ª"
  };

  CQ.goalIds = ["S3", "S4", "S5", "S6", "S7"];

  if (window.Config && Config.saves) {
    Config.saves.isAllowed = false;
    Config.saves.autosave = false;
  }

  CQ.progressKey = function (name) {
    return "cq.progress." + name;
  };

  CQ.formatDuration = function (ms) {
    if (!ms || ms < 0) ms = 0;
    var totalSeconds = Math.floor(ms / 1000);
    var minutes = Math.floor(totalSeconds / 60);
    var seconds = totalSeconds % 60;
    return minutes + " åˆ† " + (seconds < 10 ? "0" : "") + seconds + " ç§’";
  };

  CQ.now = function () {
    return Date.now();
  };

  CQ.fullwidthToHalfwidth = function (s) {
    var out = "";
    for (var i = 0; i < s.length; i++) {
      var code = s.charCodeAt(i);
      if (code === 12288) {
        out += " ";
      } else if (code >= 65281 && code <= 65374) {
        out += String.fromCharCode(code - 65248);
      } else {
        out += s.charAt(i);
      }
    }
    return out;
  };

  CQ.normalize = function (input) {
    if (input == null) return "";
    var s = String(input);
    s = CQ.fullwidthToHalfwidth(s);
    if (CQ.config.collapseWhitespace) {
      s = s.replace(/\s+/g, " ");
    }
    s = s.trim();
    s = s.toLowerCase();
    if (CQ.config.stripPunctuation) {
      s = s.replace(/[\.,/#!$%\^&\*;:{}=\-_`~()\[\]\\]/g, "");
    }
    return s;
  };

  CQ.isDigitsOnly = function (s) {
    return /^\d+$/.test(s);
  };

  CQ.splitList = function (value) {
    if (!value) return [];
    return String(value)
      .split("|")
      .map(function (v) { return v.trim(); })
      .filter(function (v) { return v.length > 0; });
  };

  CQ.parseCsv = function (text) {
    var rows = [];
    var row = [];
    var field = "";
    var inQuotes = false;

    for (var i = 0; i < text.length; i++) {
      var ch = text.charAt(i);
      var next = text.charAt(i + 1);

      if (inQuotes) {
        if (ch === '"' && next === '"') {
          field += '"';
          i++;
        } else if (ch === '"') {
          inQuotes = false;
        } else {
          field += ch;
        }
        continue;
      }

      if (ch === '"') {
        inQuotes = true;
      } else if (ch === ",") {
        row.push(field);
        field = "";
      } else if (ch === "\n") {
        row.push(field);
        rows.push(row);
        row = [];
        field = "";
      } else if (ch === "\r") {
        // ignore
      } else {
        field += ch;
      }
    }

    if (field.length > 0 || row.length > 0) {
      row.push(field);
      rows.push(row);
    }

    return rows;
  };

  CQ.loadNodesFromCsv = function (csvText) {
    var rows = CQ.parseCsv(csvText);
    if (!rows.length) return { nodes: {}, order: [] };

    var headers = rows[0].map(function (h) {
      return String(h || "").trim().toLowerCase();
    });

    var nodes = {};
    var order = [];
    var meta = {};

    for (var r = 1; r < rows.length; r++) {
      var cols = rows[r];
      if (!cols || !cols.length) continue;

      var obj = {};
      for (var c = 0; c < headers.length; c++) {
        var key = headers[c];
        obj[key] = cols[c] != null ? String(cols[c]).trim() : "";
      }

      if (!obj.id) continue;
      if (obj.id === "META") {
        if (obj.title) meta.title = obj.title;
        continue;
      }

      if (!nodes[obj.id]) {
        nodes[obj.id] = {
          id: obj.id,
          promptHTML: obj.prompt || "",
          inputPlaceholder: obj.placeholder || "",
          revisitHTML: obj.revisit || "",
          variants: []
        };
        order.push(obj.id);
      }

      if (!nodes[obj.id].promptHTML && obj.prompt) {
        nodes[obj.id].promptHTML = obj.prompt;
      }
      if (!nodes[obj.id].revisitHTML && obj.revisit) {
        nodes[obj.id].revisitHTML = obj.revisit;
      }

      if (nodes[obj.id].promptHTML) {
        nodes[obj.id].promptHTML = nodes[obj.id].promptHTML.replace(/\\n/g, "<br>");
      }
      if (nodes[obj.id].revisitHTML) {
        nodes[obj.id].revisitHTML = nodes[obj.id].revisitHTML.replace(/\\n/g, "<br>");
      }
      if (!nodes[obj.id].inputPlaceholder && obj.placeholder) {
        nodes[obj.id].inputPlaceholder = obj.placeholder;
      }

      var answers = CQ.splitList(obj.answers);
      var regexAnswers = CQ.splitList(obj.regex);
      var isFallback = answers.indexOf("*") >= 0 || regexAnswers.indexOf(".*") >= 0;

      nodes[obj.id].variants.push({
        answers: answers,
        regexAnswers: regexAnswers,
        onSuccessHTML: obj.onsuccess || "",
        nextId: obj.nextid || "",
        isFallback: isFallback
      });
    }

    return { nodes: nodes, order: order, meta: meta };
  };

  CQ.getCsvText = function () {
    var passage = Story.get("ContentCSV");
    if (!passage) return "";
    return (passage.text || "").trim();
  };

  CQ.init = function () {
    var csvText = CQ.getCsvText();
    var result = CQ.loadNodesFromCsv(csvText);
    CQ.nodes = result.nodes;
    CQ.order = result.order;
    CQ.meta = result.meta || {};

    if (State.variables.groupName == null) State.variables.groupName = "";
    if (State.variables.currentNodeId == null) State.variables.currentNodeId = "";
    if (State.variables.completedIds == null) State.variables.completedIds = [];
    if (State.variables.lastFeedback == null) State.variables.lastFeedback = "";
    if (State.variables.errorMessage == null) State.variables.errorMessage = "";
    if (State.variables.answer == null) State.variables.answer = "";

    CQ.loadProgress();
  };

  CQ.isGoal = function (id) {
    return CQ.goalIds.indexOf(id) >= 0;
  };

  CQ.markCompleted = function (id) {
    if (!CQ.isGoal(id)) return;
    if (State.variables.completedIds.indexOf(id) >= 0) return;
    State.variables.completedIds.push(id);
  };

  CQ.allGoalsCompleted = function () {
    if (!CQ.goalIds.length) return false;
    for (var i = 0; i < CQ.goalIds.length; i++) {
      if (State.variables.completedIds.indexOf(CQ.goalIds[i]) < 0) return false;
    }
    return true;
  };

  CQ.firstId = function () {
    return CQ.order && CQ.order.length ? CQ.order[0] : "";
  };

  CQ.getNode = function (id) {
    return CQ.nodes ? CQ.nodes[id] : null;
  };

  CQ.checkAnswer = function (node, userInput) {
    if (!node) return { ok: false };
    var input = CQ.normalize(userInput);
    var fallback = null;

    for (var v = 0; v < node.variants.length; v++) {
      var variant = node.variants[v];
      if (variant.isFallback) {
        fallback = variant;
        continue;
      }

      for (var i = 0; i < variant.answers.length; i++) {
        var candidateRaw = variant.answers[i];
        var candidate = CQ.normalize(candidateRaw);

        if (CQ.isDigitsOnly(candidate)) {
          if (CQ.fullwidthToHalfwidth(String(userInput)).trim() === candidate) {
            return { ok: true, nextId: variant.nextId, onSuccessHTML: variant.onSuccessHTML };
          }
        } else if (input === candidate) {
          return { ok: true, nextId: variant.nextId, onSuccessHTML: variant.onSuccessHTML };
        }
      }

      for (var r = 0; r < variant.regexAnswers.length; r++) {
        var pattern = variant.regexAnswers[r];
        try {
          var re = new RegExp(pattern);
          if (re.test(input)) {
            return { ok: true, nextId: variant.nextId, onSuccessHTML: variant.onSuccessHTML };
          }
        } catch (e) {
          // ignore invalid regex
        }
      }
    }

    if (fallback) {
      return { ok: true, nextId: fallback.nextId, onSuccessHTML: fallback.onSuccessHTML };
    }

    return { ok: false };
  };

  CQ.saveProgress = function () {
    try {
      var name = (State.variables.groupName || "").trim();
      var key = CQ.progressKey(name || "_default");
      var data = {
        currentNodeId: State.variables.currentNodeId || "",
        completedIds: State.variables.completedIds || [],
        startTime: State.variables.startTime || 0,
        endTime: State.variables.endTime || 0
      };
      localStorage.setItem(key, JSON.stringify(data));
      if (name) {
        localStorage.setItem(CQ.storageKeys.lastGroupName, name);
      }
    } catch (e) {
      // ignore storage errors
    }
  };

  CQ.loadProgress = function () {
    try {
      var name = (State.variables.groupName || "").trim();
      if (!name) {
        var last = localStorage.getItem(CQ.storageKeys.lastGroupName);
        if (last) {
          State.variables.groupName = last;
          name = last;
        }
      }

      var key = CQ.progressKey(name || "_default");
      var raw = localStorage.getItem(key);
      if (raw) {
        try {
          var data = JSON.parse(raw) || {};
          State.variables.currentNodeId = data.currentNodeId || "";
          State.variables.completedIds = data.completedIds || [];
          State.variables.startTime = data.startTime || 0;
          State.variables.endTime = data.endTime || 0;
        } catch (e) {
          State.variables.currentNodeId = "";
          State.variables.completedIds = [];
          State.variables.startTime = 0;
          State.variables.endTime = 0;
        }
      }
    } catch (e) {
      // ignore storage errors
    }
  };

  CQ.resetProgress = function () {
    try {
      var name = (State.variables.groupName || "").trim();
      localStorage.removeItem(CQ.progressKey(name || "_default"));
      if (name) {
        var last = localStorage.getItem(CQ.storageKeys.lastGroupName);
        if (last === name) localStorage.removeItem(CQ.storageKeys.lastGroupName);
      }
    } catch (e) {
      // ignore storage errors
    }
    State.variables.groupName = "";
    State.variables.currentNodeId = "";
    State.variables.completedIds = [];
    State.variables.startTime = 0;
    State.variables.endTime = 0;
    State.variables.lastFeedback = "";
    State.variables.errorMessage = "";
    State.variables.answer = "";
  };

  CQ.resetProgressForGroup = function (name) {
    try {
      var keyName = (name || "").trim();
      localStorage.removeItem(CQ.progressKey(keyName || "_default"));
    } catch (e) {
      // ignore storage errors
    }
    State.variables.currentNodeId = "";
    State.variables.completedIds = [];
    State.variables.startTime = 0;
    State.variables.endTime = 0;
  };

  CQ.ensureStartTime = function () {
    if (!State.variables.startTime) {
      State.variables.startTime = CQ.now();
    }
  };

  CQ.finishTimer = function () {
    if (!State.variables.endTime) {
      State.variables.endTime = CQ.now();
    }
  };

  CQ.getElapsedMs = function () {
    var start = State.variables.startTime || 0;
    if (!start) return 0;
    var end = State.variables.endTime || CQ.now();
    return end - start;
  };

  CQ.renderSidebar = function () {
    var total = CQ.goalIds.length;
    var done = (State.variables.completedIds || []).length;
    var dots = "";
    for (var i = 0; i < total; i++) {
      dots += i < done ? "â—" : "â—‹";
    }

    var container = document.getElementById("cq-sidebar-progress");
    if (!container) {
      var uiBody = document.getElementById("ui-bar-body") || document.getElementById("ui-bar");
      if (!uiBody) return;
      container = document.createElement("div");
      container.id = "cq-sidebar-progress";
      uiBody.appendChild(container);
    }

    var duration = CQ.formatDuration(CQ.getElapsedMs());
    container.innerHTML = "" +
      "<div class=\"cq-sidebar-title\">é€²åº¦</div>" +
      "<div class=\"cq-sidebar-text\">å·²å®Œæˆ " + done + " / " + total + " å€‹ç·šç´¢</div>" +
      "<div class=\"cq-progress-dots\" aria-label=\"progress\">" + dots + "</div>" +
      "<div class=\"cq-sidebar-text\">æ™‚é–“ " + duration + "</div>";
  };

  CQ.applyBackground = function (passageName) {
    var id = passageName || "";
    if (id === "Gate") {
      id = State.variables.currentNodeId || "Gate";
    }

    var body = document.body;
    if (!body) return;

    var classes = body.className ? body.className.split(/\s+/) : [];
    var keep = [];
    for (var i = 0; i < classes.length; i++) {
      if (classes[i].indexOf("cq-bg-") !== 0) keep.push(classes[i]);
    }
    body.className = keep.join(" ");

    if (id) {
      body.classList.add("cq-bg-" + id);
    }
  };

  $(document).on(":storyready :passagedisplay", function () {
    $("#menu-item-saves, #menu-story-saves, .saves, a[data-passage='Saves']").remove();
    if (setup.cq && setup.cq.renderSidebar) setup.cq.renderSidebar();
    if (setup.cq && setup.cq.applyBackground) {
      var name = (State && State.passage) ? State.passage : (typeof passage !== "undefined" && passage.title ? passage.title : "");
      setup.cq.applyBackground(name);
    }
  });

  setup.cq = CQ;
})();
